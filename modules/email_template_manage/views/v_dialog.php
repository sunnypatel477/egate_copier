        <div class="modal-header">            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>            <h4 class="modal-title">                <span class="edit-title"><?php echo _l('email_template_manage')?></span>            </h4>        </div>        <?php echo form_open_multipart('email_template_manage/save' ); ?>            <input type="hidden" name="id" id="id">            <div class="modal-body">                <div class="row">                    <div class="col-md-8">                        <div class="col-md-6">                            <?php                            $related_type = [];                            $related_type[] = [ 'id' => 'all' , 'name' => _l('all') ];                            foreach ( $trigger_merge as $t_m => $t_d )                            {                                $related_type[] = [ 'id' => $t_m , 'name' => _l($t_m) ];                            }                            echo render_select('related_type', $related_type, array('id', 'name'), 'email_template_manage_related_type',  !empty( $data->related_type ) ? $data->related_type : 'all', [ 'onchange' => 'related_trigger_merge()' ]);                            ?>                        </div>                        <div class="col-md-6">                            <div class="form-group" style="margin-top: 15px">                                <div class="checkbox checkbox-primary checkbox-inline">                                    <input type="checkbox" id="is_public" name="is_public" <?php if ( !isset( $data->is_public ) || $data->is_public == 1) { echo 'checked'; } ?> >                                    <label for="is_public" ><?php echo _l('task_public'); ?></label>                                </div>                            </div>                        </div>                        <div class="col-md-12">                            <?php echo render_input('template_name', 'email_template_manage_template_name' , '' , '' , [ 'required' => true ]); ?>                            <?php echo render_input('template_subject', 'email_template_manage_email_subject' , '' , '' , [ 'required' => true ]); ?>                            <textarea class="tinymce tinymce-manual" id="template_content" name="template_content"><?php echo !empty( $data->template_content ) ? $data->template_content : ''?></textarea>                            <!-- Uploaded filed -->                            <?php if ( !empty( $data->attachments ) ) { ?>                                <div class="col-md-8 col-md-offset-1">                                    <hr class="hr-panel-separator" />                                    <p class="bold"> Files </p>                                    <?php foreach ($data->attachments as $attachment ) {                                        $attachment_url = site_url('download/file/sales_attachment/' . $attachment['attachment_key']);                                        if (!empty($attachment['external'])) {                                            $attachment_url = $attachment['external_link'];                                        } ?>                                        <div class="mbot15 row" data-attachment-id="<?php echo $attachment['id']; ?>">                                            <div class="col-md-8">                                                <div class="pull-left"><i                                                            class="<?php echo get_mime_class($attachment['filetype']); ?>"></i></div>                                                <a href="<?php echo $attachment_url; ?>"                                                   target="_blank"><?php echo $attachment['file_name']; ?></a>                                                <br />                                                <small class="text-muted"> <?php echo $attachment['filetype']; ?></small>                                            </div>                                            <div class="col-md-4 text-right">                                                <?php if ($attachment['visible_to_customer'] == 0) {                                                    $icon    = 'fa-toggle-off';                                                    $tooltip = _l('show_to_customer');                                                } else {                                                    $icon    = 'fa-toggle-on';                                                    $tooltip = _l('hide_from_customer');                                                } ?>                                                <?php if ($attachment['staffid'] == get_staff_user_id() || is_admin()) { ?>                                                    <a href="#" class="text-danger"                                                       onclick="delete_email_template_manage_attachment(<?php echo $attachment['id']; ?>); return false;"><i                                                                class="fa fa-times"></i></a>                                                <?php } ?>                                            </div>                                        </div>                                        <?php                                    } ?>                                </div>                            <?php } ?>                        </div>                    </div>                    <div class="col-md-4">                        <a><p><strong> <?php echo _l('available_merge_fields')?> </strong></p></a>                        <div style="height: 500px; overflow: auto">                            <?php foreach ( $data_merge_fields as $merge_type => $merge_data ) { ?>                                <div class="col-md-12 div_merge_fields filter_merge_<?php echo $merge_type;?>">                                    <br />                                    <p>                                        <b><?php echo _l($merge_type)?></b>                                        <?php if ( !empty( $trigger_merges[ $merge_type ] ) ) {                                            $merge_type_text = "" ;                                            foreach ( $trigger_merges[ $merge_type ] as $trigger_merge )                                            {                                                $merge_type_text .= _l( $trigger_merge )." | ";                                            }                                            if ( !empty( $merge_type_text ) )                                            {                                                echo "<span title='$merge_type_text' style='float: right'> "._l('email_template_manage_trigger_available_related_types')." </span>";                                            }                                        } ?>                                    </p>                                    <?php foreach ( $merge_data as $merge) {                                        if( empty( $merge["key"] ) )                                            continue;                                        echo "<a href='#' class='add_merge_field'>                                                 <span style='float: left'> ".$merge["name"]." </span>                                                  <span class='add_merge_field_span' style='float: right'> ".$merge["key"]." </span>                                             </a> <br />";                                    }?>                                </div>                            <?php } ?>                        </div>                    </div>                </div>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-default" data-dismiss="modal"><?php echo _l('close'); ?></button>                <button type="submit" class="btn btn-primary"><?php echo _l('submit'); ?></button>            </div>        <?php echo form_close(); ?>        <script>            var trigger_merge = <?php echo json_encode($trigger_merge);?>            $(document).ready(function (){                var selected_related_type = $("#related_type option:selected").val();                                if (selected_related_type !== 'all'){                    show_hide_trigger_merge(selected_related_type);                }            });            function related_trigger_merge()            {                var type = $('#related_type').val();                if (type !== ''){                    if ( type == 'all' )                        $(".div_merge_fields").show();                    else                        show_hide_trigger_merge(type);                }            }            function show_hide_trigger_merge(type) {                var show_type = trigger_merge[type];                $(".div_merge_fields").hide();                $(".filter_merge_other").show();                $.each(show_type , function ( i, h ) {                    $(".filter_merge_" + h).show();                })            }        </script>